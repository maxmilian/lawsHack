<!doctype html>
<html>
    <head>
        <title>理狗駭：法律引用網絡分析</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="css/header.css">
        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="https://cdn.rawgit.com/needim/noty/77268c46/lib/noty.css">
    </head>
    <body>
        <div class="header">
            <a href="#default" class="logo"><img src="logo.png" alt="LegalHack" style="height: 60px;"></a>
            <div class="header-right">
                <a class="active" href="#home">Home</a>
                <a href="#contact">Contact</a>
            </div>
        </div>
        <div class="content">
            <div class="filter">
                <div style="margin: 15px; font-size: 24px;">
                    判決數:<br/>
                    <span id="count_case" class="statistics">-</span><br/>
                    判決年度:<br/>
                    <span class="statistics">1996 - 2019</span><br/>
                    節點數:<br/>
                    <span id="count_node" class="statistics">-</span><br/>
                    引用數:<br/>
                    <span id="count_relation" class="statistics">-</span>
                </div>
                <div style="margin-top: 15px;">
                    <div class="section">
                        案號<br/>
                        <input type="search" id="yearcaseno" name="yearcaseno" placeholder="105訴123"/><br/>
                        案由<br/>
                        <input type="search" id="title" name="title" placeholder="損害賠償"/>
                    </div>
                    <div class="section">
                        顯示數量<br/>
                        <select name="limit">
                            <option value="10000">10000</option>
                            <option value="5000">5000</option>
                            <option value="3000">3000</option>
                            <option value="1000" selected>1000</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                    <div class="section">
                        重要程度<br/>
                        <select name="pagerank">
                            <option value="0.5">最重要</option>
                            <option value="0.24">重要</option>
                            <option value="0.21" selected>普通</option>
                            <option value="0.18">不重要</option>
                            <option value="0.15">最不重要</option>
                        </select>
                    </div>
                    <div class="section">
                        <label><input type="checkbox" id="arrows" checked>顯示方向</label>
                    </div>
                    <div style="margin: 10px;">
                        <button id="apply">套用</button>
                    </div>
                </div>
            </div>
            <div id="viz"></div>
        </div>

        <script src="https://rawgit.com/neo4j-contrib/neovis.js/master/dist/neovis.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
        <script src="https://cdn.rawgit.com/needim/noty/77268c46/lib/noty.min.js"></script>
        <script src="https://unpkg.com/jquery-easy-loading/dist/jquery.loading.min.js"></script>
        <script src="js/neovis.js"></script>
        <script type="text/javascript">

        function enableCondition(enabled) {
            $("select[name=limit]").attr('disabled', !enabled);
            $("select[name=pagerank]").attr('disabled', !enabled);
        }

        $("#yearcaseno").bind("keyup change", function(e) {
            if ($("#yearcaseno").val() != "") {
                enableCondition(false);
                $("#title").val("");
            } else {
                enableCondition(true);
            }
        });

        $("#title").bind("keyup change", function(e) {
            if ($("#title").val() != "") {
                $("#yearcaseno").val("");
                enableCondition(true);
            }
        });

        function resetNeovisConfig() {
            let searchParams = new URLSearchParams(window.location.search);

            let limit = searchParams.get('limit');
            let pagerank = searchParams.get('pagerank');
            let cypher = "MATCH (n)-[r:REFER]->(m) WHERE m.pagerank > 0.21 RETURN * ORDER BY m.pagerank LIMIT 1000";
            let yearcaseno = searchParams.get('yearcaseno');
            let title = searchParams.get('title');
            let arrows = searchParams.get('arrows') == "true" ? true : false;

            if (yearcaseno != "") {
                cypher = "MATCH (n)-[r:REFER*1..2]-(m) WHERE n.yearcaseno = '" + yearcaseno + "' RETURN *";
            } else {
                let title = searchParams.get('title');

                cypher = "";
                if (title != "") {
                    cypher = "CALL db.index.fulltext.queryNodes(\"title\", \"" + title + "\") YIELD node ";
                }
                cypher += "MATCH (node)-[r:REFER]->(m) WHERE m.pagerank > " + pagerank + " RETURN * ORDER BY m.pagerank, node.pagerank LIMIT " + limit;
            }
            console.log(cypher);
            if (arrows != showArrows) {
                neovisConfig.arrows = arrows;
                neovisConfig.initial_cypher = cypher;
                $("#viz").loading();
                viz.reinit(neovisConfig);

                showArrows = arrows;
            } else {
                $("#viz").loading();
                viz.renderWithCypher(cypher);
            }
        }

        $("#apply").click(function() {
            var params = {
                limit: $("select[name=limit]").val(),
                pagerank: $("select[name=pagerank]").val(),
                yearcaseno: $("#yearcaseno").val(),
                title: $("#title").val(),
                arrows: $("#arrows").is(":checked"),
            };

            var url = window.location.pathname + "?" + jQuery.param(params);
            history.pushState({}, null, url);

            resetNeovisConfig();
        });

        function initConfig() {
            let searchParams = new URLSearchParams(window.location.search);

            let limit = searchParams.get('limit');
            let pagerank = searchParams.get('pagerank');
            let cypher = "MATCH (n)-[r:REFER]->(m) WHERE m.pagerank > 0.21 RETURN * ORDER BY m.pagerank LIMIT 1000";
            let yearcaseno = searchParams.get('yearcaseno');
            let title = searchParams.get('title');
            let arrows = searchParams.get('arrows') == "true" ? true : false;
        }

        $(document).ready(function() {
            $.get("rest/count_case", function(data) {
                $("#count_case").text(numeral(data.count).format('0,0'));
            }).fail(function() {
                $("#count_node").text('0');
            });
            $.get("rest/count_node", function(data) {
                $("#count_node").text(numeral(data.count).format('0,0'));
            }).fail(function() {
                $("#count_node").text('0');
            });
            $.get("rest/count_relation", function(data) {
                $("#count_relation").text(numeral(data.count).format('0,0'));
            }).fail(function() {
                $("#count_relation").text('0');
            });
            $("#viz").loading();
            draw();
        });
    </script>
    </body>
</html>
